<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>

	<style type="text/css">

	left_directories_column {
		background-color: 'white';

		margin-left: 0;
		width: 300px;
		height: 600px;
		float: left;
	}

	.direcotriesTable {
		overflow : auto;
	    width: 100%;
	    height: 100%;
	    table-layout: fixed;
	    border-collapse: collapse;
	    border-spacing: 0;
	}
	.direcotriesTable > tbody > tr {
	    height:20px;
	    vertical-align:middle;
	}
	.direcotriesTable > tbody > tr > td {
	    height:20px;
	    overflow: hidden;
	    vertical-align: middle;
	}


	middle_iframe_box {
		background-color: 'white';
		margin-left: 300px;
		height: 600px;
		overflow: hidden;
	}

	bottom_set_rules_block {
		background-color: 'white';
		height: 300px;
		width: 100%;
	}

	directory_table_entry {
		display: 'inline-block';
		width: 100%;
		height: 20px;
	}



	</style>

	<head>

	<form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>" id="hidden_post_form" type="hidden">
		<input type="text" name="CHILD_DIR_REQUEST"></input>
	</form>
	</head>
	<div>
	
	<left_directories_column id="directories_column">

	<table class='direcotriesTable' id='directories_table'>

	</table>
	</left_directories_column>

	</div>
		<?php

		//NOT SURE IF THIS ACTUALLY WORKLS
			if($_SERVER["REQUEST_METHOD"] == "POST") {
				if(isset($_POST['CHILD_DIR_REQUEST'])) {
					$request_text = $_POST['CHILD_DIR_REQUEST'];

					//call another function that processes the request text sending it back as a hidden element to be scooped up by the javascript
					$response_text = getFoldersText($request_text);
					echo "<div type='hidden' id='CHILD_DIR_RESPONSE_TEXT'>".$response_text."</div>";
				}
				
			}
		?>

</html>


<script>

	var directories_info_form =  document.getElementById("directories_info_form");
	
	var directories_table = document.getElementById("directories_table");

	var rootDirectoriesAndFiles = new Array();

	var allDirectoriesAndFiles;


	var pluggin_url ='';

	//the table will be loaded with the first files and directories in the defined_root_dir
	var tableRows = directories_table.getElementsByTagName("tr");
	var i;


	var directoriesTableRelation;

	//start by creating dirNodes of all the root dirs with the data info from html bit
	for(i=0; i < tableRows.length; i++) {
		var isDirectory = tableRows[i].getAttribute('data-isDirectory');
		var path = tableRows[i].getAttribute('data-path');
		var dirName = tableRows[i].innerHTML;

		allDirectoriesAndFiles[path] = new DirectoryAndFileNode(isDirectory, path, dirName, '/');
		allDirectoriesAndFiles[path].showing=true;
		allDirectoriesAndFiles[path].cell=tableRows[i];

		tableRows[i].onclick() = table_cell_clicked(allDirectoriesAndFiles[path]);


	}
	


	function httpGet(theUrl)
	{
	    var xmlHttp = new XMLHttpRequest();
	    xmlHttp.open( "GET", theUrl, false );
	    xmlHttp.send( null );
	    return xmlHttp.responseText;
	}


	//this posts to the hidden form in the head, then calls a timeout set function up to 8 times to see if the extra hidden element was returned 

	function postHiddenFormInfo(stringToPost, type, cellNode) {
		var theForm = document.getElementById('hidden_post_form');
		var theInput;
		var theResponse;
		//this will just be text response
		if(type == 'CHILD_DIR_REQUEST') {
			//set the request in the form input field
			theInput=theForm.getElementsByName("CHILD_DIR_REQUEST");
			theInput.innerHTML=stringToPost;
			theForm.submit();
			theForm.reset();
			
			var i=0;
			//each time the function in timeout returns false, goto timeout runs, until a max of 8 times
timeout:	setTimeout(function(){
				if(getHiddenFormText(type)==false){
					if(i<8){
						i++;
						goto timeout;
					}
					else{
						//has been three seconds with no good result, give up, lol
					}
				}
				else{
					//on success,response text is passed to the callback functions
					theResponse = hidden_form_child_dir_return_text;
					hidden_form_child_dir_return_text = null;
					request_children_from_server_callback(cellNode, theResponse);
				}

			}, 250);
		}



	}

	var hidden_form_child_dir_return_text=null;

	

	function getHiddenFormText(type) {

		var responseElement;
		if(type == 'CHILD_DIR_REQUEST') {
			responseElement = document.getElementById('CHILD_DIR_RESPONSE_TEXT');
			//if the element doesnt exist, there was no return yet  <--- not sure if this actually works
			if(responseElement == null) {
				return false;
			}
			else {
				//
				hidden_form_child_dir_return_text = responseElement.innerHTML;
				responseElement.parentNode.removeChild(responseElement);
				return true;
			}
		}
	}
	//each level needs a data set, do not always want to download
	//data-parent
	//data-children_directories
	//data-children_files

	//cell is the actual element var

	function DirectoryAndFileNode(isDirectory, path, dirName, parentDirNode) {
		if(isDirectory==null || path==null || name == null || parent == null) {
			return null;
		}
		this.showing = false;
		this.cell=null;
		this.isDirectory = isDirectory;
		this.path = path;
		this.dirName = dirName;
		this.parentDirNode = parentDirNode;
		this.childrenKnown = false;
		this.isExpanded = false;
		this.depth = path.split('/').length;

		this.chilrenFiles = new array();
		this.childrenDirectories = new array();
		return this;
		
	}


	function display_children(cellNode) {

		if(cellNode.showing == false){
				//really shouldnt happen
		}
		else {
			var k;
			var currentTableIndex = cellNode.cell.rowIndex+1;
			var newRow;
			var depthSpace='';
			//root depth is 1, but indents for root dirs is 0
			for(k=0; cellNode.depth; k++) {
				depthSpace.concat('	');
			}

			for(k=0; k<cellNode.childrenDirectories.length; k++) {
				newRow = directories_table.insertRow(currentTableIndex);
				newRow.innerHTML = depthSpace+'DIRECTORY: 'cellNode.childrenDirectories[k].dirName;
				//NEED TO SET IF FILE OR IF IS DIRECTORY USING CSS ELEMENT
				newRow.setAttribute('data-isDirectory', 'true');
				newRow.setAttribute('data-path', cellNode.childrenDirectories[k].path);
					currentTableIndex++;
			}

			for(k=0; k<cellNode.childrenFiles.length; k++) {
				newRow = directories_table.insertRow(currentTableIndex);
				newRow.innerHTML = depthSpace+'FILE: 'cellNode.childrenFiles[k].dirName;
				//NEED TO SET IF FILE OR IF IS DIRECTORY USING CSS ELEMENT
				newRow.setAttribute('data-isDirectory', 'false');
				newRow.setAttribute('data-path', cellNode.childrenFiles[k].path);

				currentTableIndex++;
			}
		}

	}

	function request_children_from_server(cellNode) {
		var post_string= 'request_children_for=' + cellNode.path;
		postHiddenFormInfo(post_string, 'CHILD_DIR_REQUEST', cellNode);
	}

	function request_children_from_server_callback(cellNode, returnString) {
		if(returnString==null || returnString.length==0){
			//error
			return -1;
		}
		if(returnString == "NO CHILDREN"){
			cellNode.childrenKnown = true;
		}
		else{
			var directoriesAndFiles = returnString.split("\n");
			var j;
			var singleDirInfo;
			var dirOrFileName;
			var newIsDir;
			var newFileNode;
			for(j=0; j<directoriesAndFiles.length; j++) {
				singleDirInfo = directoriesAndFiles[j].split("::");
				if(singleDirInfo.length != 2) {
					//skip, bad format
				}
				else{
					if( (dirOrFileName=singleDirInfo[0]).length==0) {
						//skip bad format
					}
					else{
						newIsDir=singleDirInfo[1];
						if(newIsDir != 'true' && newIsDir != 'false') {
							//again skip, bad format
						}
						else{
							newFileNode = new DirectoryAndFileNode( ((newIsDir == 'true') ? true:false), cellNode.path+'/'+dirName, dirName, cellNode);
							allDirectoriesAndFiles[newFileNode.path] = newFileNode;

							if(newIsDir==true){
								cellNode.childrenDirectories.push(newFileNode);
							}
							else{
								cellNode.childrenFiles.push(newFileNode);
							}

						}
					}
				}
			}
			cellNode.childrenKnown = true;
			display_children(cellNode);
		}
	}

	function table_cell_clicked(cellNode) {

		var get_string;
		var returnString;
		if(cell.isDirectory == true){

			if(cellNode.isExpanded == true) {
				return 0;
			}

			if(cell.childrenKnown == false) {
				request_children_from_server(cellNode);
				return 'requesting';

			}

			else {
				display_children(cellNode);
			}
		}
		else {
			//IS A FILE :O, will need to get the html file, weooo
		}
		
	}

</script>
